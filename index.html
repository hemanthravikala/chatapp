// === CONFIG ===
const ACCOUNTS_SHEET = "Accounts";
const MESSAGES_SHEET = "Messages";
const VERIFICATION_SHEET = "Verification";

// === UTILITY FUNCTIONS ===
function getSheet(sheetName) {
  return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
}

function generateOTP() {
  return Math.floor(100000 + Math.random() * 900000).toString(); // 6-digit
}

function getCurrentTime() {
  return new Date();
}

// === SIGNUP → GENERATE OTP ===
function signupUser(name, email) {
  const verSheet = getSheet(VERIFICATION_SHEET);
  const verData = verSheet.getDataRange().getValues();

  for (let i = 1; i < verData.length; i++) {
    if (verData[i][2] === email && verData[i][4] === "pending") {
      return {status: false, message: "OTP already sent, check email"};
    }
  }

  const otp = generateOTP();
  const tempId = verSheet.getLastRow(); 
  const time = getCurrentTime();
  verSheet.appendRow([tempId, name, email, otp, "pending", time]);

  MailApp.sendEmail(email, "Your OTP for ChatApp", "Your OTP is: " + otp);

  return {status: true, message: "OTP sent successfully"};
}

// === VERIFY OTP → CREATE ACCOUNT ===
function verifyOTP(name, email, otp) {
  const verSheet = getSheet(VERIFICATION_SHEET);
  const accSheet = getSheet(ACCOUNTS_SHEET);
  const verData = verSheet.getDataRange().getValues();

  for (let i = 1; i < verData.length; i++) {
    if (
      verData[i][1] === name &&
      verData[i][2] === email &&
      verData[i][3].toString() === otp.toString() && 
      verData[i][4] === "pending"
    ) {
      const newId = accSheet.getLastRow(); 
      const createdTime = getCurrentTime();
      accSheet.appendRow([newId, name, email, otp, createdTime, "active"]);

      verSheet.getRange(i + 1, 5).setValue("verified");

      return {status: true, message: "Account created successfully"};
    }
  }
  return {status: false, message: "OTP verification failed"};
}

// === LOGIN ===
function loginUser(name, email, password) {
  const accSheet = getSheet(ACCOUNTS_SHEET);
  const accData = accSheet.getDataRange().getValues();

  for (let i = 1; i < accData.length; i++) {
    if (accData[i][1] === name && accData[i][2] === email && accData[i][3].toString() === password.toString()) {
      return {status: true, message: "Login successful"};
    }
  }
  return {status: false, message: "Invalid credentials"};
}

// === SEND MESSAGE ===
function sendMessage(fromEmail, toEmail, message) {
  const accSheet = getSheet(ACCOUNTS_SHEET);
  const accData = accSheet.getDataRange().getValues();

  let recipientExists = false;
  for (let i = 1; i < accData.length; i++) {
    if (accData[i][2] === toEmail) {
      recipientExists = true;
      break;
    }
  }
  if (!recipientExists) return {status: false, message: "Recipient not found"};

  const msgSheet = getSheet(MESSAGES_SHEET);
  const timestamp = getCurrentTime();
  msgSheet.appendRow([fromEmail, toEmail, message, timestamp]);
  return {status: true, message: "Message sent"};
}

// === FETCH MESSAGES FOR USER ===
function getMessages(email) {
  const msgSheet = getSheet(MESSAGES_SHEET);
  const msgData = msgSheet.getDataRange().getValues();
  const userMessages = [];

  for (let i = 1; i < msgData.length; i++) {
    if (msgData[i][1] === email) { 
      userMessages.push({
        from: msgData[i][0],
        message: msgData[i][2],
        timestamp: msgData[i][3]
      });
    }
  }
  return userMessages;
}

// === MAIN WEB APP ENDPOINTS ===

function doOptions(e) {
  return ContentService
    .createTextOutput()
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}

function doPost(e) {
  let response;
  try {
    const data = JSON.parse(e.postData.contents);

    switch (data.action) {
      case "signup":
        response = signupUser(data.name, data.email);
        break;
      case "verifyOTP":
        response = verifyOTP(data.name, data.email, data.otp);
        break;
      case "login":
        response = loginUser(data.name, data.email, data.password);
        break;
      case "sendMessage":
        response = sendMessage(data.fromEmail, data.toEmail, data.message);
        break;
      case "getMessages":
        response = getMessages(data.email);
        break;
      default:
        response = {status: false, message: "Invalid action"};
    }
  } catch (err) {
    response = {status: false, message: "Error in script: " + err.message};
  }

  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(Content.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}

function doGet(e) {
  return ContentService
    .createTextOutput("ChatApp Web App is running")
    .setMimeType(ContentService.MimeType.TEXT);
}
